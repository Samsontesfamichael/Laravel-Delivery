name: Deploy Laravel Delivery

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PHP_VERSION: '8.2'
  NODE_VERSION: '18'

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: laravel_delivery
        ports:
          - 3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, bcmath, redis
          coverage: xdebug

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Composer
        run: composer install --no-interaction --prefer-dist

      - name: Install NPM
        run: npm ci

      - name: Build Assets
        run: npm run production

      - name: Copy Environment File
        run: cp .env.example .env

      - name: Generate Key
        run: php artisan key:generate

      - name: Directory Permissions
        run: chmod -R 755 bootstrap/cache storage

      - name: Run Migrations
        run: php artisan migrate --force
        env:
          DB_HOST: 127.0.0.1
          DB_PORT: ${{ job.services.mysql.ports[3306] }}
          DB_DATABASE: laravel_delivery
          DB_USERNAME: root
          DB_PASSWORD: root

      - name: Run Tests
        run: php artisan test --coverage

      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/laravel.xml
          flags: unittests

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: Install Composer
        run: composer install --no-interaction --prefer-dist

      - name: PHP CodeSniffer
        run: |
          composer require --dev squizlabs/php_codesniffer
          vendor/bin/phpcs --standard=phpcs.xml app/

      - name: PHPStan
        run: |
          composer require --dev phpstan/phpstan
          vendor/bin/phpstan analyse app/ --level=5

  security:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: Install Composer
        run: composer install --no-interaction --prefer-dist

      - name: Run Security Audit
        run: |
          composer require --dev roave/security-advisories
          composer audit

      - name: OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'Laravel Delivery'
          path: '.'
          format: HTML

  deploy-staging:
    name: Deploy to Staging
    needs: [test, code-quality, security]
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Staging Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_KEY }}
          script: |
            cd /var/www/laravel-delivery
            git pull origin main
            composer install --no-interaction
            npm run production
            php artisan migrate --force
            php artisan cache:clear
            php artisan config:clear

  deploy-production:
    name: Deploy to Production
    needs: [test, code-quality, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Production Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PRODUCTION_HOST }}
          username: ${{ secrets.PRODUCTION_USER }}
          key: ${{ secrets.PRODUCTION_KEY }}
          script: |
            cd /var/www/laravel-delivery
            git pull origin main
            composer install --no-interaction --optimize-autoloader
            npm run production
            php artisan migrate --force
            php artisan cache:clear
            php artisan config:clear
            php artisan view:clear
            sudo systemctl restart php8.2-fpm
            sudo systemctl restart nginx
